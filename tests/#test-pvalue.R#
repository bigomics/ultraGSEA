library(playbase)
source("~/Playground/playbase/dev/include.R",chdir=TRUE)
source("../R/zgsea.R")
source("../R/gsetcor.R")
source("../R/gmt-utils.R")

counts  <- playbase::COUNTS
samples <- playbase::SAMPLES
head(samples)
X <- playbase::logCPM(counts)
y <- samples$activated

## compute logFC
res <- playbase::gx.limma(X, pheno=y, fdr=1, lfc=0)
fc <- res$logFC
names(fc) <- rownames(res)
head(res)

G <- Matrix::t(playdata::GSETxGENE)
#G <- G[,grep("HALLMARK",colnames(G))]
G <- G[,grep("^GO_",colnames(G))]
gg <- intersect(rownames(X),rownames(G))
G <- G[gg,]
X <- X[gg,]
fc <- fc[gg]
gmt <- mat2gmt(G)
head(names(gmt))
length(gmt)
G <- gmt2mat(gmt)
G <- G[gg,names(gmt)]
dim(G)

res1 <- fgsea::fgsea(gmt, fc, eps=0)
res2 <- zgsea(fc, G, method='ztest')
res3 <- zgsea(fc, G, method='cor')

gs <- names(gmt)
res1 <- res1[match(gs,res1$pathway),]
res2 <- res2[match(gs,res2$pathway),]
res3 <- res3[match(gs,res3$pathway),]

stats <- as.numeric(rep(NA, ncol(G)))
pvals <- as.numeric(rep(NA, ncol(G)))
names(stats) <- colnames(G)
names(pvals) <- colnames(G)
fc.idx <- apply(G,2,function(x) which(x!=0))
length(fc.idx)
i=1
for (i in 1:ncol(G)) {  
  ii <- fc.idx[[i]]
  ks <- ks.test(y = fc[ii], x = fc[-ii])
  ##ks <- ks.test(x=ii, y=1:length(fc))
  zsign <- -1 + 2*(mean(fc[ii])>0)
  stats[i] <- zsign*ks$statistic
  pvals[i] <- ks$p.value
}

Z <- cbind( ES=res1$ES, NES=res1$NES, zgsea.z=res2$score,
  zgsea.cor=res3$score, ks=stats)
pairs(Z, pch=20, cex=0.8)

P <- cbind(res1$pval, res2$pval, res3$pval, ks=pvals)
pairs(-log10(P), pch=20, cex=0.8)


library(npGSEA)


gs2 <- GeneSet(setName = "Geneset2", geneIds = c("geneD", "geneE"))
my_gene_set_list <- list(gs1, gs2)


gsc <- GeneSetCollection(
res3 <- npGSEA::npGSEA(x = X, y = y, set = gsc)


