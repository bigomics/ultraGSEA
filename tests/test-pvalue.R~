library(playbase)
source("~/Playground/playbase/dev/include.R",chdir=TRUE)
source("../R/zgsea.R")
source("../R/gsetcor.R")
source("../R/gmt-utils.R")

counts  <- playbase::COUNTS
samples <- playbase::SAMPLES
head(samples)
X <- playbase::logCPM(counts)
y <- samples$activated

pgx <- playbase::pgx.load("~/Playground/pgx/tcga-brca_pub.pgx")
X <- pgx$X
head(pgx$samples)
y <- 1*(pgx$samples$ER_STATUS=="Positive")
#y <- 1*(pgx$samples$.cell_cycle=="G1")

## compute logFC
res <- playbase::gx.limma(X, pheno=y, fdr=1, lfc=0)
fc <- res$logFC
names(fc) <- rownames(res)
head(res)

G <- Matrix::t(playdata::GSETxGENE)
G <- G[,grep("HALLMARK",colnames(G))]
G <- G[,grep("^GO_",colnames(G))]
gg <- intersect(rownames(X),rownames(G))
G <- G[gg,]
X <- X[gg,]
fc <- fc[gg]
gmt <- mat2gmt(G)
head(names(gmt))
length(gmt)
G <- gmt2mat(gmt)
dim(G)

rc <- playbase::signedRank(fc)

res <- list()
tt <- peakRAM::peakRAM(
  res$fgsea <- fgsea::fgsea(gmt, fc, eps=0),
  res$zgsea.z <- zgsea(fc, G, method='ztest'),
  res$zgsea.t <- zgsea(fc, G, method='ttest'),
  res$zgsea.c <- zgsea(fc, G, method='cor'),
  res$zgsea.rz <- zgsea(rc, G, method='ztest'),
  res$zgsea.rt <- zgsea(rc, G, method='ttest'),
  res$zgsea.rc <- zgsea(rc, G, method='cor'),  
  res$cor <- gset.cor(fc, G, compute.p=TRUE, use.rank=FALSE),
  res$rankcor  <- gset.cor(fc, G, compute.p=TRUE, use.rank=TRUE)  
)
tt
tt[,1] <- names(res)
tt

## align results
gs <- names(gmt)
res$fgsea <- res$fgsea[match(gs,res$fgsea$pathway),]
ii <- grep("gsea",names(res))
for(i in ii) {
  res[[i]] <- res[[i]][match(gs,res[[i]]$pathway),]
}

## show test-statistics (e.g. NES,rho,t)
ii <- grep("zgsea",names(res))
Z <- cbind( fgsea=res$fgsea$NES)
Z <- cbind(Z, do.call(cbind, lapply(res[ii], function(x) x$score)))
Z <- cbind(Z, cor=res$cor$rho[gs,1], rankcor=res$rankcor$rho[gs,1] ) 
head(Z)
pairs(Z, cex=3, pch='.')

x11()
P <- cbind( fgsea=res$fgsea$pval)
P <- cbind(P, do.call(cbind, lapply(res[ii], function(x) x$pval)))
P <- cbind(P, cor=res$cor$p.value[gs,1], rankcor=res$rankcor$p.value[gs,1] ) 
##pairs(-log10(P), cex=0.6, pch=20)
pairs(-log10(P), cex=3, pch='.')

par(mfrow=c(3,3))
plot(res$fgsea$NES, -log10(res$fgsea$pval),
  pch=20, cex=0.8, main="fgsea")
ii <- grep("zgsea",names(res))
for(i in ii) {
  plot(res[[i]]$score, -log10(res[[i]]$pval), 
    pch=20, cex=0.8, main=names(res)[i])
}
plot(res$cor$rho[gs,1], -log10(res$cor$p.value[gs,1]),
  pch=20, cex=0.8, main="gset.cor")
plot(res$rankcor$rho[gs,1], -log10(res$rankcor$p.value[gs,1]),
  pch=20, cex=0.8, main="gset.rankcor")

##---------------------------------------------------------------
##----------------------- zGSEA ---------------------------------
##---------------------------------------------------------------
source("../R/zgsea.R")

fres <- fgsea::fgsea(gmt, fc)
zres <- zgsea(fc, G, addLE=TRUE, method='cor')
zres <- zgsea(fc, G, addLE=TRUE, method='ztest', minLE=1)
head(zres)
fres <- fres[match(names(gmt),fres$pathway),]
zres <- zres[match(names(gmt),zres$pathway),]

k=10
gg1 <- fres$leadingEdge[[k]]
gg2 <- zres$leadingEdge[[k]]
gg1
gg2
gg1 %in% gg2
gg2 %in% gg1

